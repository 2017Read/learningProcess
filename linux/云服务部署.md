# 阿里云服务部署
* 连接远程服务 `ssh root@公网IP`
* 查看数据盘信息 `fdisk -l`
* 查看硬盘信息`df -h`

### 添加用户
`adduser xuthus`
`gpasswd -a xuthus sudo` sudo组
`sudo visudo`然后进入nano编辑器，添加`xuthus ALL=(ALL:ALL) ALL`
保存后依次执行：ctrl+x, shift+y,enter

### 配置`ssh`
先生成ssh，公钥，私钥，和git生成一致`ssh-keygen -t rsa -b 4096 -C "xxxgit@sina.com"`

然后进入`.ssh`目录， 执行`eval "$(ssh-agent -s)"`代理，
再添加`ssh-add ~/.ssh/id_rsa`

云服务器也按同样的方法生成，执行。

云服务在`.ssh`目录下还要生成`authorized_keys`文件，`vi authorized_keys`,进入，然后`esc`，在执行`shift加：`，输入`wq!`,回车

在本地，`cat id_rsa.pub`，复制里面内容

然后在云服务`vi authorized_keys`，将刚才复制私钥添加进去，先按`i`，然后粘贴，然后`esc`，在执行`shift加：`，输入`wq!`,回车

授权`chmod 600 authorized_keys`，`sudo service ssh restart`，就可以通过ssh登入了，不用使用密码

### 修改默认端口，服务区默认端口为22

`sudo vi /etc/ssh/sshd_config`，修改port： `39999`，
在到最后一行添加`AllowUsers 用户名`

重启ssh`sudo service ssh restart`

### 安装nodejs环境
`sudo apt-get install vim openssl build-essential libssl-dev wget curl git`

nvm
`wget -qO- https://raw.githubusercontent.com/creationix/nvm/v0.33.2/install.sh | bash`

`nvm install v版本号`
`nvm use v版本号`
`nvm alias default v版本号` // 指定默认

`npm install -g npm`

`echo fs.inotify.max_user_watches=524288 | sudo tee -a /etc/sysctl.conf && sudo sysctl -p`

`npm i pm2 webpack gulp grunt-cli -g`

通过nodejs搭建服务器，监听的端口号需要注意，不是所有端口都可以，可以查看阿里云网站控制台—>云服务ECS -> 安全组规则，查看放行的端口，也可以自己修改`http://106.14.173.2:3389/`

### 安装nginx
`sudo apt-get install nginx`

`cd /etc/nginx/conf.d`

新建配置文件`sudo vi xxxuthus-cn-3389.conf`，文件名自定义

```
upstream xxxuthus {
  server 127.0.0.1:3389;
}

server {
  listen 80;
  server_name 106.14.173.2;

  location / {
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forward-For $proxy_add_x_forwarded_for;
    proxy_set_header Host $http_host;
    proxy_set_header X-Nginx-Proxt true;

    proxy_pass http://xxxuthus;
    proxy_redirect off;
  }
}
```
测试配置文件`sudo nginx -t`

重启`sudo nginx -s reload`

端口占用后，可以使用`pkill node`

如果访问不到，可以查看阿里云网站控制台—>云服务ECS -> 安全组规则，看是否放行80端口，不放行的话，自己添加

### 使用DNSPOD解析域名(`https://www.dnspod.cn/`)

进阿里云控制台（点击域名->管理）将域名的dns地址，改为DNSPOD的 [DNS](https://support.dnspod.cn/Kb/showarticle/tsid/40/)(万网是阿里旗下的)

然后进入DNSPOD控制台->域名解析->添加域名

添加后，点击域名进入，添加记录，输入`www`，选择`A类`,输入`云服务器ip`

### 使用七牛
登录七牛->对象存储->新建存储空间->绑定域名(融合CDN加速域名)，输入要加速的域名(必须是已经备案的)，其余默认，然后等待生效

进入DNSPOD的域名解析，点击添加记录，主机名比如`main`,记录类型`CNAME`，记录值填写：从刚才在七牛那配置的CDN加速域名那复制，当配置生效后，七牛那会显示CNAME，复制即可

随后就可以使用七牛的图床，内容管理->上传图片->可以访问图片外链地址，如`http://ou1r84eii.bkt.clouddn.com/jerry.jpeg`，改为自己的域名`http://main.xxxuthus.cn/jerry.jpeg`，仍可以正常使用，表示配置成功

### 服务器配置mongodb
安装[依次执行12345命令](https://docs.mongodb.com/manual/tutorial/install-mongodb-on-ubuntu/)

启动mongodb数据库服务`sudo service mongod start `
然后`mongo`

停止`sudo service mongod stop`
重启`sudo setvice mongod restart`

修改mongodb端口，
`sudo vi /etc/mongod.conf`
重启
`mongo --port 29999`

#### 备份一个完整数据库
将本地数据库部署到服务器

    -d 数据库名字
    -o 导出到的位置
    mongodump -h 127.0.0.1:27017 -d vnpastime -o /home/xuthus/project-data/vnpastime-backup

打包

  `tar zcvf vnpastime.tar.gz vnpastime-backup `

发送到服务器

    -P 服务器端口
    最后是主机+路径
    scp -P 22 ./vnpastime.tar.gz xuthus_y@106.14.173.2:/home/xuthus_y/dbbackup

登录云服务器

解压
`tar xvf vnpastime.tar.gz`

恢复到云主机数据库
    
    --host 数据库服务
    最后面是备份文件的路径
    mongorestore --host 127.0.0.1:19999 -d vnpastime ./dbbackup/vnpastime-backup/vnpastime/

#### 备份单表

本地

    mongoexport -d 数据库名称 -c 表名 [-q '{"name": {$ne: null}}'] -o ./名称.json

    scp -P 22 ./名称.json xuthus_y@106.14.173.2:/home/xuthus_y/dbbackup


服务器

    mongoimport --host 127.0.0.1:19999 -d 数据库名称 -c 表名 ./名称.json

删除数据库

    mongo --host 127.0.0.1:19999 数据库名 --eval "db.dropDatabase()"

